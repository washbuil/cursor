---
import '../../styles/globals.css';
import Header from '../../components/Header.astro';
import { getDb } from '../../lib/firebase';
import { getDocs, getDoc, collection, doc } from 'firebase/firestore';

const PLACEHOLDER_IMAGE = 'https://placehold.co/800x500?text=No+Image';

export async function getStaticPaths() {
  const db = getDb();
  if (!db) return [];
  try {
    const snapshot = await getDocs(collection(db, 'cars'));
    return snapshot.docs.map((d) => ({ params: { id: d.id } }));
  } catch (_err) {
    return [];
  }
}

interface CarData {
  id: string;
  /** API用の車両ID（数値）。Firestoreの car_id フィールド */
  carId: number;
  name: string;
  subtitle: string;
  description: string;
  image: string;
  images: string[];
  pricePerDay: number;
  rating: number;
  reviews: number;
  location: string;
  capacity: string;
  features: string[];
  pet: number;
  pickupLocation: { name: string; address: string; hours: string; phone: string };
  /** add_form API用 */
  stationCode: string;
  ownerCode: string;
  calendarId: string;
  emails: string;
}

function getImageUrl(value: unknown): string {
  if (value == null || String(value).trim() === '') return PLACEHOLDER_IMAGE;
  const url = String(value).trim();
  if (url.startsWith('gs://')) return PLACEHOLDER_IMAGE;
  return url;
}

const { id } = Astro.params;
let car: CarData | null = null;

const db = getDb();
if (db && id) {
  try {
    const docSnap = await getDoc(doc(db, 'cars', id));
    if (docSnap.exists()) {
      const data = docSnap.data();
      const mainImage = data.main_image ?? data.car_img;
      const imageUrl = getImageUrl(mainImage);
      const features: string[] = [];
      if (data.pet === 1) features.push('ペット可');
      if (data.toilet === 1) features.push('トイレ付');
      if (data.aircon === 1) features.push('エアコン');
      const rideCapa = data.ride_capa;
      const capacityStr = rideCapa != null ? `${rideCapa}名` : '—';
      const stationName = data.station_name != null ? String(data.station_name) : '';

      // TODO: 正しい価格フィールド（例: price_day）に変更する
      const pricePerDay = 15000;

      const realCarId = data.car_id != null ? Number(data.car_id) : 0;
      const stationCode = data.station_code != null ? String(data.station_code) : '2';
      const ownerCode = data.owner_code != null ? String(data.owner_code) : '1';
      const calendarId = data.calendar_id != null ? String(data.calendar_id) : '1';
      const emails = data.emails != null ? String(data.emails) : 'mail@washbuil.com';

      car = {
        id: docSnap.id,
        carId: realCarId,
        name: data.car_name != null ? String(data.car_name) : '名前なし',
        subtitle: rideCapa != null ? `${rideCapa}名様向け` : 'キャンピングカー',
        description: data.description != null ? String(data.description) : 'この車両の詳細はお問い合わせください。',
        image: imageUrl,
        images: [imageUrl],
        pricePerDay,
        rating: 4.9,
        reviews: 0,
        location: stationName,
        capacity: capacityStr,
        features,
        pet: data.pet === 1 ? 1 : 0,
        pickupLocation: {
          name: stationName || '受取場所',
          address: data.station_address != null ? String(data.station_address) : '—',
          hours: data.station_hours != null ? String(data.station_hours) : '—',
          phone: data.station_phone != null ? String(data.station_phone) : '—',
        },
        stationCode,
        ownerCode,
        calendarId,
        emails,
      };
    }
  } catch (_err) {
    car = null;
  }
}

function formatPrice(value: number): string {
  return `¥${value.toLocaleString()}`;
}
---

<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={car ? `${car.name} - キャンピングカーレンタル` : '車両詳細'} />
    <title>{car ? `${car.name} | キャンピングカーレンタル` : '車両が見つかりません'}</title>
  </head>
  <body class="min-h-screen bg-background text-foreground">
    <Header />

    <main class="pt-20">
      {!car ? (
        <div class="container mx-auto max-w-6xl px-4 py-16 text-center">
          <h1 class="text-2xl font-bold text-foreground">車両が見つかりません</h1>
          <p class="mt-4 text-muted-foreground">指定されたIDの車両は存在しないか、削除された可能性があります。</p>
          <a href="/" class="mt-6 inline-block rounded-md bg-primary px-6 py-2.5 text-sm font-medium text-primary-foreground hover:opacity-90">一覧に戻る</a>
        </div>
      ) : (
        <div class="container mx-auto px-4 py-8">
          <div class="flex flex-col gap-8 lg:flex-row">
            <div class="lg:w-2/3">
              <div class="mb-6 flex flex-col gap-4">
                <div class="flex items-start justify-between">
                  <div>
                    <h1 class="text-2xl font-bold text-foreground text-balance md:text-3xl">{car.name}</h1>
                    <p class="mt-1 text-muted-foreground">{car.subtitle}</p>
                  </div>
                  <div class="flex shrink-0 gap-2">
                    <button type="button" class="rounded-md border border-border bg-transparent p-2 hover:bg-muted" aria-label="共有">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
                    </button>
                    <button type="button" class="rounded-md border border-border bg-transparent p-2 hover:bg-muted" aria-label="お気に入り">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
                    </button>
                  </div>
                </div>
                <div class="flex flex-wrap items-center gap-4 text-sm">
                  <div class="flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" class="text-primary"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                    <span class="font-medium">{car.rating}</span>
                    <span class="text-muted-foreground">({car.reviews}件のレビュー)</span>
                  </div>
                  {car.location && (
                    <div class="flex items-center gap-1 text-muted-foreground">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                      <span>{car.location}</span>
                    </div>
                  )}
                  <span class="rounded-md bg-secondary px-2.5 py-0.5 text-xs font-medium text-secondary-foreground">即時予約可</span>
                </div>
              </div>

              <!-- PhotoGallery -->
              <div class="mb-8 overflow-hidden rounded-lg border border-border bg-muted">
                <img src={car.image} alt={car.name} class="h-auto w-full object-cover" width="800" height="500" />
                {car.images.length > 1 && (
                  <div class="grid grid-cols-3 gap-2 p-2">
                    {car.images.slice(1, 4).map((img, i) => (
                      <img key={i} src={img} alt={`${car.name} ${i + 2}`} class="aspect-video w-full rounded object-cover" width="200" height="133" />
                    ))}
                  </div>
                )}
              </div>

              <div class="space-y-8">
                <section>
                  <h2 class="mb-4 text-xl font-semibold text-foreground">この車両について</h2>
                  <div class="prose prose-neutral max-w-none">
                    {car.description.split('\n\n').map((paragraph, index) => (
                      <p key={index} class="mb-4 leading-relaxed text-muted-foreground">{paragraph}</p>
                    ))}
                  </div>
                </section>

                <!-- VehicleSpecs -->
                <section>
                  <h2 class="mb-4 text-xl font-semibold text-foreground">諸元・スペック</h2>
                  <dl class="grid gap-3 rounded-lg border border-border bg-card p-4 sm:grid-cols-2">
                    <div class="flex justify-between border-b border-border pb-2 sm:border-b-0 sm:border-r sm:pr-4">
                      <dt class="text-muted-foreground">定員</dt>
                      <dd class="font-medium text-foreground">{car.capacity}</dd>
                    </div>
                    <div class="flex justify-between pb-2 sm:border-b-0 sm:border-r sm:pr-4">
                      <dt class="text-muted-foreground">受取場所</dt>
                      <dd class="font-medium text-foreground">{car.pickupLocation.name || '—'}</dd>
                    </div>
                  </dl>
                </section>

                <!-- EquipmentList (features as badges) -->
                {car.features.length > 0 && (
                  <section>
                    <h2 class="mb-4 text-xl font-semibold text-foreground">装備・特徴</h2>
                    <ul class="flex flex-wrap gap-2">
                      {car.features.map((f) => (
                        <li>
                          <span class="inline-flex rounded-full bg-secondary px-3 py-1 text-sm font-medium text-secondary-foreground">{f}</span>
                        </li>
                      ))}
                    </ul>
                  </section>
                )}

                <!-- LocationMap -->
                <section>
                  <h2 class="mb-4 text-xl font-semibold text-foreground">受取・返却場所</h2>
                  <div class="rounded-lg border border-border bg-card p-4">
                    <p class="font-medium text-foreground">{car.pickupLocation.name}</p>
                    <p class="mt-1 text-sm text-muted-foreground">{car.pickupLocation.address}</p>
                    <p class="mt-1 text-sm text-muted-foreground">営業: {car.pickupLocation.hours}</p>
                    <p class="mt-1 text-sm text-muted-foreground">TEL: {car.pickupLocation.phone}</p>
                  </div>
                </section>
              </div>
            </div>

            <!-- BookingCard (price_calculate API 連携) -->
            <aside class="lg:w-1/3" id="booking-card" data-car-id={car.id}>
              <div class="lg:sticky lg:top-24">
                <div class="rounded-lg border border-border bg-card shadow-lg">
                  <div class="space-y-4 p-4">
                    <div class="overflow-hidden rounded-lg border border-border">
                      <div class="p-3 space-y-3">
                        <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">日程</div>
                        <div class="grid grid-cols-2 gap-3">
                          <label class="flex flex-col gap-1 text-sm text-foreground">
                            <span class="text-muted-foreground">出発日</span>
                            <input type="date" id="booking-start-day" class="rounded-md border border-input bg-background px-2 py-1.5 text-foreground text-sm focus:outline-none focus:ring-2 focus:ring-ring w-full" />
                          </label>
                          <label class="flex flex-col gap-1 text-sm text-foreground">
                            <span class="text-muted-foreground">出発時間</span>
                            <select id="booking-start-time" class="rounded-md border border-input bg-background px-2 py-1.5 text-foreground text-sm focus:outline-none focus:ring-2 focus:ring-ring w-full">
                              {Array.from({ length: 24 }, (_, i) => {
                                const h = i < 10 ? '0' + i : '' + i;
                                const display = h + ':00';
                                return <option value={String(i)}>{display}</option>;
                              })}
                            </select>
                          </label>
                          <label class="flex flex-col gap-1 text-sm text-foreground">
                            <span class="text-muted-foreground">返却日</span>
                            <input type="date" id="booking-end-day" class="rounded-md border border-input bg-background px-2 py-1.5 text-foreground text-sm focus:outline-none focus:ring-2 focus:ring-ring w-full" />
                          </label>
                          <label class="flex flex-col gap-1 text-sm text-foreground">
                            <span class="text-muted-foreground">返却時間</span>
                            <select id="booking-end-time" class="rounded-md border border-input bg-background px-2 py-1.5 text-foreground text-sm focus:outline-none focus:ring-2 focus:ring-ring w-full">
                              {Array.from({ length: 24 }, (_, i) => {
                                const h = i < 10 ? '0' + i : '' + i;
                                const display = h + ':00';
                                return <option value={String(i)}>{display}</option>;
                              })}
                            </select>
                          </label>
                        </div>
                      </div>
                      {car.pet === 1 && (
                        <div class="border-t border-border p-3">
                          <label class="flex items-center gap-2 text-sm text-foreground cursor-pointer">
                            <input type="checkbox" id="booking-pet" class="rounded border-input text-primary focus:ring-ring" />
                            <span>ペット同乗</span>
                          </label>
                        </div>
                      )}
                    </div>
                    <div class="rounded-lg border border-border bg-muted/30 p-4 text-center">
                      <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground mb-1">料金</div>
                      <div id="booking-final-price" class="text-2xl font-bold text-foreground tabular-nums">---</div>
                    </div>
                    <p id="booking-message" class="text-center text-sm text-muted-foreground">出発日・返却日・時間を選択すると料金が表示されます</p>
                    <button type="button" id="btn-reserve" class="h-12 w-full rounded-md bg-primary text-base font-semibold text-primary-foreground hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed">予約する</button>
                  </div>
                  <div class="flex flex-col gap-3 border-t border-border p-4 pt-0">
                    <div class="flex items-center justify-center gap-2 text-sm text-muted-foreground">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-primary"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                      <span>予約確定まで料金はかかりません</span>
                    </div>
                  </div>
                </div>
              </div>
            </aside>
          </div>
        </div>
      )}
    </main>

    <footer class="mt-12 border-t border-border bg-primary py-12 text-primary-foreground">
      <div class="container mx-auto max-w-6xl px-4">
        <div class="flex flex-col items-center justify-between gap-6 md:flex-row">
          <a href="/" class="text-lg font-bold text-primary-foreground">キャンピングカーレンタル</a>
          <nav class="flex flex-wrap items-center justify-center gap-6 text-sm text-primary-foreground/90">
            <a href="/#vehicles" class="hover:text-primary-foreground">車両</a>
            <a href="/#features" class="hover:text-primary-foreground">特徴</a>
            <a href="/#how-it-works" class="hover:text-primary-foreground">ご利用の流れ</a>
            <a href="/#faq" class="hover:text-primary-foreground">よくある質問</a>
            <a href="#" class="hover:text-primary-foreground">お問い合わせ</a>
          </nav>
        </div>
        <p class="mt-8 text-center text-sm text-primary-foreground/70">© {new Date().getFullYear()} キャンピングカーレンタル. All rights reserved.</p>
      </div>
    </footer>

 <script define:vars={{ 
      carId: car?.carId ?? null, 
      apiToken: import.meta.env.PUBLIC_API_TOKEN, 
      stationCode: car?.stationCode ?? '2', 
      ownerCode: car?.ownerCode ?? '1', 
      calendarId: car?.calendarId ?? '1', 
      emails: car?.emails ?? 'mail@washbuil.com', 
      stationName: car?.pickupLocation?.name ?? '横浜上永谷', 
      carName: car?.name ?? '車両名' 
    }}>
      // サーバーからの変数を window オブジェクト（グローバル変数）に保存します
      window.bookingData = {
        carId,
        apiToken,
        stationCode,
        ownerCode,
        calendarId,
        emails,
        stationName,
        carName
      };
    </script>

    <script>
      import { getCurrentUser } from '../../lib/auth';

      document.addEventListener('DOMContentLoaded', () => {
        // 保存したデータを取得
        const { carId, apiToken, stationCode, ownerCode, calendarId, emails, stationName, carName } = window.bookingData;

        const API_PRICE_URL = 'https://roadcruise-share.com/api/lending/price_calculate';

        const card = document.getElementById('booking-card');
        if (!card) return;

        const authHeader = apiToken != null && apiToken !== '' ? { 'Authorization': 'Bearer ' + apiToken } : {};
        const startDayInput = document.getElementById('booking-start-day');
        const endDayInput = document.getElementById('booking-end-day');
        const startTimeSelect = document.getElementById('booking-start-time');
        const endTimeSelect = document.getElementById('booking-end-time');
        const petCheckbox = document.getElementById('booking-pet');
        const finalPriceEl = document.getElementById('booking-final-price');
        const messageEl = document.getElementById('booking-message');
        const reserveBtn = document.getElementById('btn-reserve');

        if (!startDayInput || !endDayInput || !startTimeSelect || !endTimeSelect || !finalPriceEl || !messageEl || !reserveBtn) return;

        let lastFinalPrice = null;
        let calculationResult = null;

        function setMessage(text, isError) {
          messageEl.textContent = text;
          messageEl.className = 'text-center text-sm ' + (isError ? 'text-destructive' : 'text-muted-foreground');
        }

        function setFinalPriceDisplay(text) {
          finalPriceEl.textContent = text;
        }

        function getPetValue() {
          return (petCheckbox && petCheckbox.checked) ? 'あり' : '';
        }

        function calculatePrice() {
          const startDay = startDayInput.value;
          const endDay = endDayInput.value;
          const startTime = startTimeSelect.value;
          const endTime = endTimeSelect.value;

          if (!startDay || !endDay || startTime === '' || endTime === '') {
            setFinalPriceDisplay('---');
            setMessage('出発日・返却日・時間を選択すると料金が表示されます');
            lastFinalPrice = null;
            calculationResult = null;
            return;
          }

          const startDt = new Date(startDay + 'T' + (startTime.length === 1 ? '0' + startTime : startTime) + ':00:00');
          const endDt = new Date(endDay + 'T' + (endTime.length === 1 ? '0' + endTime : endTime) + ':00:00');
          if (endDt <= startDt) {
            setFinalPriceDisplay('---');
            setMessage('返却日時は出発日時より後にしてください');
            lastFinalPrice = null;
            calculationResult = null;
            return;
          }

          reserveBtn.disabled = true;
          setFinalPriceDisplay('計算中...');
          setMessage('計算中...');

          fetch(API_PRICE_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', ...authHeader },
            body: JSON.stringify({
              car_id: carId,
              start_day: startDay,
              start_time: startTime,
              end_day: endDay,
              end_time: endTime,
              pet: getPetValue(),
              plan: ''
            })
          })
            .then(function (res) {
              if (!res.ok) throw new Error('料金の取得に失敗しました');
              return res.json();
            })
            .then(function (data) {
              calculationResult = data;
              const price = data.final_price != null ? data.final_price : null;
              lastFinalPrice = price;
              if (price != null) {
                setFinalPriceDisplay('¥' + Number(price).toLocaleString('ja-JP'));
                setMessage('上記の合計で予約できます');
              } else {
                setFinalPriceDisplay('---');
                setMessage('料金を取得できませんでした');
                calculationResult = null;
              }
            })
            .catch(function (err) {
              setFinalPriceDisplay('---');
              setMessage(err.message || '通信エラー', true);
              lastFinalPrice = null;
              calculationResult = null;
              console.error('price_calculate error:', err);
            })
            .finally(function () {
              reserveBtn.disabled = false;
            });
        }

        // URLパラメータで検索条件をフォームに反映
        const params = new URLSearchParams(window.location.search);
        const pStartDay = params.get('start_day');
        const pEndDay = params.get('end_day');
        const pStartTime = params.get('start_time');
        const pEndTime = params.get('end_time');

        if (pStartDay) startDayInput.value = pStartDay;
        if (pEndDay) endDayInput.value = pEndDay;
        if (pStartTime) startTimeSelect.value = pStartTime;
        if (pEndTime) endTimeSelect.value = pEndTime;

        if (pStartDay && pEndDay) {
          calculatePrice();
        }

        startDayInput.addEventListener('change', calculatePrice);
        startDayInput.addEventListener('input', calculatePrice);
        endDayInput.addEventListener('change', calculatePrice);
        endDayInput.addEventListener('input', calculatePrice);
        startTimeSelect.addEventListener('change', calculatePrice);
        endTimeSelect.addEventListener('change', calculatePrice);
        if (petCheckbox) petCheckbox.addEventListener('change', calculatePrice);

        // 予約ボタン処理
        reserveBtn.addEventListener('click', function submitReservation() {
          // 1. ログインチェック
          const user = getCurrentUser();
          if (!user) {
            alert('予約するにはログインが必要です。');
            window.location.href = '/login';
            return;
          }

          // 2. 計算結果チェック
          if (calculationResult == null) {
            alert('料金を計算してから予約してください。日程・時間を選択し、料金が表示された状態で予約ボタンを押してください。');
            return;
          }
          
          const startDay = startDayInput.value;
          const endDay = endDayInput.value;
          const startTime = startTimeSelect.value;
          const endTime = endTimeSelect.value;

          if (!startDay || !endDay || startTime === '' || endTime === '') {
            alert('出発日・返却日・時間を選択してください');
            return;
          }
          
          const startDt = new Date(startDay + 'T' + (startTime.length === 1 ? '0' + startTime : startTime) + ':00:00');
          const endDt = new Date(endDay + 'T' + (endTime.length === 1 ? '0' + endTime : endTime) + ':00:00');
          
          if (endDt <= startDt) {
            alert('返却日時は出発日時より後にしてください');
            return;
          }

          if (!confirm('この内容で予約リクエストを送信しますか？')) return;

          reserveBtn.disabled = true;
          reserveBtn.textContent = '送信中...';

          // 3. 送信データの作成 (ログインユーザー情報を使用)
          const payload = {
            calendar_id: calendarId,
            car_id: String(carId), // 文字列に変換
            owner_code: ownerCode,
            station_code: stationCode,
            emails: emails,
            user_email: user.email ?? 'mail@washbuil.com',
            first_name: 'ユーザー', // 必要であれば別途入力欄を作るか、DBから取得
            last_name: '名',
            flutter_user_id: user.uid, // ★ここがログインユーザーのIDになります
            start_day: startDay,
            start_time: startTime,
            end_day: endDay,
            end_time: endTime,
            usage_time: calculationResult.hours,
            total_price: calculationResult.total_price,
            final_price: calculationResult.final_price,
            long_term_discount: calculationResult.long_term_discount,
            plan_discount: calculationResult.plan_discount,
            pet: getPetValue(),
            status: '仮予約',
            station: stationName,
            car: carName,
            role: 'admin'
          };

          fetch('https://roadcruise-share.com/api/lending/add_form', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', ...authHeader },
            body: JSON.stringify(payload)
          })
            .then(function (res) {
              if (!res.ok) throw new Error('予約の送信に失敗しました');
              return res.json().catch(function () { return {}; });
            })
            .then(function (data) {
              alert('予約リクエストを送信しました');
              window.location.href = '/reservation-complete?id=' + data.id;
            })
            .catch(function (err) {
              alert(err.message || '予約処理でエラーが発生しました');
              reserveBtn.disabled = false;
              reserveBtn.textContent = '予約する';
              console.error('add_form error:', err);
            });
        });
      });
    </script>
  </body>
</html>
 